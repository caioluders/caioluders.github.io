<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
</head>

<body><h1>Six files that are also a valid PHP</h1>
<p>1496966400</p>
<p>And a GIF that is also a Python</p>
<p>That history begins with me trying to make a GIF that is also a valid Haskell, all that for a <a href="https://github.com/p4-team/ctf/tree/master/2016-12-27-33c3/web_150_try">CTF challenge</a>. Although was a pain in the ass to kill this challenge, the idea of having one file that has two format was really interesting and somewhat useful to bypass upload restrictions and execute the unexpected type of your file with some LFI.</p>
<p><img alt="The GIF/Haskell fileÂ ,made by Manoel (@reefbr)" src="img/1__eSoHgZ68ph7Np4Z__9i__1rw.png" />
The GIF/Haskell fileÂ ,made by Manoel (@reefbr)</p>
<h3>GIF +Â PHP</h3>
<p>I was reading the <a href="https://www.alchemistowl.org/pocorgtfo/">PoC||GTFO</a> Journal and they love the idea of a <em>polyglot file</em>, one of their issues is a <a href="https://www.alchemistowl.org/pocorgtfo/pocorgtfo14.pdf">PDF/Zip and NES ROMÂ </a>, so I started with the simplestâ€Šâ€”â€Šand probably the only one that is usefulâ€Šâ€”â€Šfile formatÂ : PHP. Why is the simplest? Because you can state where the code starts with &lt;? and where it ends withÂ ?&gt;Â , with that I can put the PHP code anywhere in the file.</p>
<p>I already knew something about GIF, so letâ€™s start with it. Having in mind that the content of the GIF is worthless to us the <a href="http://probablyprogramming.com/2009/03/15/the-tiniest-gif-ever">tiniest GIF possible</a> is a great place to startÂ :</p>
<p>HEX   : 47 49 46 38 39 61 01 00 01 00 00 FF 00 2C 00 00 00 00 01 00 01 00 00 02 00 3B</p>
<p>ASCII : GIF89aï¿½ï¿½ï¿½Ã¿ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½;</p>
<p>As explained in the blog post, that makes a 1x1 black gif and it should break because it doesnâ€™t have the <a href="http://www.matthewflickinger.com/lab/whatsinagif/bits_and_bytes.asp">Global Color Table</a>, but it works because the readers does not follow the specification at risk. Now I want to put my PHP string somewhere in there. Reading the <a href="https://www.w3.org/Graphics/GIF/spec-gif89a.txt">GIF89a Specification</a> Iâ€™ve found the Comment Extension which allow us to put a comment in the GIF at the end of the file. Something like thatÂ :</p>
<pre><code>                        7 6 5 4 3 2 1 0        Field Name                    Type  
                     +---------------+  
                0  |      0x21     |       Extension Introducer          Byte  
                     +---------------+  
                1  |      0xFE     |       Comment Label                 Byte  
                     +---------------+

                     +===============+  
                     |    &lt;?         |  
                N  |    phpinfo(); |       Comment Data            Data Sub-blocks  
                     |               |  
                     +===============+

                     +---------------+  
                0  |       ;       |       Block Terminator              Byte  
                     +---------------+
</code></pre>
<p>So now we can append our PHP code as a comment in the GIFÂ :</p>
<p>HEX   : 47 49 46 38 39 61 01 00 01 00 00 FF 00 2C 00 00 00 00 01 00 01 00 00 02 00 21 FE 3C 3F 70 68 70 69 6E 66 6F 28 29 3B<br />
ASCII : GIF89aï¿½ï¿½ï¿½Ã¿ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½!Ã¾&lt;?phpinfo();</p>
<p>Note thatÂ !Ã¾ = 0x21 0xFEÂ , and PHP doesnâ€™t require theÂ ?&gt; at the end. Also GIF makes easy for us having the <a href="https://en.wikipedia.org/wiki/End-of-file">EOF</a> as a semicolon.</p>
<h3>PHP +Â PDF</h3>
<p>Following the steps of PoC||GTFO letâ€™s play with PDF. The plan still the same, get the simplest PDF possible and try to append a comment.</p>
<p>I had a problem with the first part of the plan, I use OS X and his PDF reader is restrict as fuck, almost every simple PDF that Iâ€™ve found in the internet has some error for the OS Xâ€™s reader. The only one that is all in ASCII and worked for me was this one: <a href="https://stackoverflow.com/a/32142316">https://stackoverflow.com/a/32142316</a></p>
<pre><code>            %PDF-1.2 9 0 obj&lt;&lt;&gt;&gt;streamBT/ 9 Tf(Test)' ETendstreamendobj4 0 obj&lt;&lt;/Type /Page/Parent 5 0 R/Contents 9 0 R&gt;&gt;endobj5 0 obj&lt;&lt;/Kids [4 0 R ]/Count 1/Type /Pages/MediaBox [ 0 0 99 9 ]&gt;&gt;endobj3 0 obj&lt;&lt;/Pages 5 0 R/Type /Catalog&gt;&gt;endobjtrailer&lt;&lt;/Root 3 0 R&gt;&gt;%%EOF
</code></pre>
<p>It has a lot of parts that isnâ€™t required for other readers, like the Chromeâ€™s reader, and it should be really smaller but it doesnâ€™t matter. PDF is much simpler, like any program language it has a code for comments which is %Â , so just put that after any line and append the PHP codeÂ .</p>
<pre><code>            %PDF-1.2 %&lt;?phpinfo()?&gt;
</code></pre>
<h3>Simplest approach</h3>
<p>Surfing in the WEB Iâ€™ve found <a href="https://github.com/mathiasbynens/small">something really beautiful</a>Â , a repository with a huge list with the â€œSmallest possible [â€¦] fileâ€œ, so I started to try append PHP to some of that files.</p>
<p>As it turns out, most of the files has a <a href="https://en.wikipedia.org/wiki/End-of-file">EOF</a> of some kind to state that the file has ended, and most readers just ignores anything that is put after that <a href="https://en.wikipedia.org/wiki/End-of-file">EOF</a>. Here is four examplesÂ :</p>
<h4>ELF +Â PHP</h4>
<pre><code>            HEX   : 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00 02 00 03 00 01 00 00 00 19 40 CD 80 2C 00 00 00 00 00 00 00 00 00 00 00 34 00 20 00 01 00 00 00 00 00 00 00 00 40 CD 80 00 40 CD 80 4C 00 00 00 4C 00 00 00 05 00 00 00 00 10 00 00 3C 3F 70 68 70 69 6E 66 6F 28 29 3B 3F 3E  
            ASCII : ELFï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½@Ãâ‚¬,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½4ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½@Ãâ‚¬ï¿½@Ãâ‚¬Lï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½&lt;?phpinfo();?&gt;
</code></pre>
<h4>MP3 +Â PHP</h4>
<pre><code>            HEX   : FF E3 18 C4 00 00 00 03 48 00 00 00 00 4C 41 4D 45 33 2E 39 38 2E 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 3C 3F 70 68 70 69 6E 66 6F 28 29 3B 3F 3E  
            ASCII : Ã¿Ã£Ã„ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½LAME3.98.2ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½&lt;?phpinfo();?&gt;
</code></pre>
<h4>JPG +Â PHP</h4>
<pre><code>            HEX   : FF D8 FF DB 00 43 00 03 02 02 02 02 02 03 02 02 02 03 03 03 03 04 06 04 04 04 04 04 08 06 06 05 06 09 08 0A 0A 09 08 09 09 0A 0C 0F 0C 0A 0B 0E 0B 09 09 0D 11 0D 0E 0F 10 10 11 10 0A 0C 12 13 12 10 13 0F 10 10 10 FF C9 00 0B 08 00 01 00 01 01 01 11 00 FF CC 00 06 00 10 10 05 FF DA 00 08 01 01 00 00 3F 00 D2 CF 20 FF D9 3C 3F 70 68 70 69 6E 66 6F 28 29 3B 3F 3E  
            ASCII : Ã¿Ã˜Ã¿Ã›ï¿½Cï¿½


                
                  
              
              
             Ã¿Ã‰ï¿½ ï¿½ï¿½ï¿½Ã¿ÃŒï¿½ï¿½Ã¿Ãšï¿½ï¿½ï¿½?ï¿½Ã’Ã Ã¿Ã™&lt;?phpinfo();?&gt;
</code></pre>
<p>Append PHP to JPEG is really old, but everyone just put in the <a href="https://en.wikipedia.org/wiki/Exif">EXIF</a>, and I consider it cheating.</p>
<h4>BMP +Â PHP</h4>
<pre><code>            HEX  : 42 4D 1E 00 00 00 00 00 00 00 1A 00 00 00 0C 00 00 00 01 00 01 00 01 00 18 00 00 00 FF 00 3C 3F 70 68 70 69 6E 66 6F 28 29 3B 3F 3E  
            ASCI : BMï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã¿ï¿½&lt;?phpinfo();?&gt;
</code></pre>
<h3>Bonus roundÂ :</h3>
<p>After that finding I started playing with something more hardcore. A GIF that is also a valid Python. None of the above â€œ<em>techniques</em>â€ works because you canâ€™t just say to Python Interpreter where to start to run the code like PHP. Letâ€™s take another look at another GIFÂ :</p>
<pre><code>            HEX   : 47 49 46 38 39 61 01 00 01 00 80 01 00 FF FF FF 00 00 00 21 F9 04 01 0A 00 01 00 2C 00 00 00 00 01 00 01 00 00 02 02 4C 01 00 3B  
            ASCII : GIF89aï¿½ï¿½â‚¬ï¿½Ã¿Ã¿Ã¿ï¿½ï¿½ï¿½!Ã¹  
            ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½;
</code></pre>
<p>Letâ€™s try a error based analysis, what is the error that this file gives when run as aÂ .pyÂ ?</p>
<pre><code>            $ python tinytrans.gif  
                File "tinytrans.gif", line 1  
                    GIF89a  
      ^
</code></pre>
<p>SyntaxError: invalid syntax</p>
<p>It throws a syntax error at the 0x01 byte, which is expected. The <a href="https://en.wikipedia.org/wiki/Magic_number_%28programming%29#Magic_numbers_in_files">GIF Magic Number</a> specifies that is a GIF and that his version is â€œ89aâ€, it turns out that every reader just require that the version is 89 or 87 ignoring the â€œaâ€ part, so we can replace the â€œaâ€ with a â€œ=â€ and state that â€œGIF89â€ is a variable, that should be a nice start. Letâ€™s run again.</p>
<pre><code>            $ python tinytrans.gif  
                File "tinytrans.gif", line 1  
                    GIF89=  
                                ^  
            SyntaxError: invalid syntax
</code></pre>
<p>AgainÂ , as expected. The first idea that I have was to just comment the gibberish part of the GIF and put a comment, just like at the PHP+GIF, that is a valid python and it was going to be fine. But in the middle of the gibberish it has a 0x0a byte, which is also a new line, that bugs all my attempts. I was trying to make something like thisÂ :</p>
<pre><code>            GIF89=\\  
            #GIBBERISH$@!\_K$!@$!(@#@!\_#)!@!@!Ã¾\\  
            \_\_import\_\_('os').system('ls');
</code></pre>
<p>That is, a multi-line variable declaration using the â€˜\â€™ and in the middle of it just commenting the Non-ASCII, after that appending the â€˜!Ã¾â€™ to start a GIF comment, jumping to another line and putting the actual code, following by the EOFâ€™s semicolon, which is also valid in Python.</p>
<p>But trying to make a comment in a multi-line variable declaration was just impossible, but making that inside a parentheses was validÂ : <a href="https://stackoverflow.com/a/22914853">https://stackoverflow.com/a/22914853</a>Â . New tryÂ :</p>
<pre><code>            HEXÂ :

            47 49 46 38 39 3D 28 0A 00 00 80 01 00 FF FF FF 00 00 00 21 F9 04 01 00 00 01 00 2C 00 00 00 00 01 00 01 00 00 02 02 4C 01 00 21 FE 0A 5F 5F 69 6D 70 6F 72 74 5F 5F 28 27 6F 73 27 29 2E 73 79 73 74 65 6D 28 27 6C 73 27 29 29 3B

            ASCIIÂ :

            GIF89=(  
            ï¿½ï¿½â‚¬ï¿½Ã¿Ã¿Ã¿ï¿½ï¿½ï¿½!Ã¹ï¿½ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½!Ã¾  
            \_\_import\_\_('os').system('ls'));
</code></pre>
<p>Note that the interpreter will just ignore the line that starts with a Non-ASCII character, which is odd, so we donâ€™t need the #Â . And RunningÂ :</p>
<pre><code>            $ python python.gif  
            bash.gif  handtinyblack.gif php.elf   php.mp3   tinytrans.gif  
            bmp.bmp   php-logo-virus.jpg php.gif   php.pdf   tinytrans.gpy  
            dude.gif  php.bmp   php.jpg   python.gif  tinytrans.py
</code></pre>
<p>YayÂ !</p></body></html>